name: Cleanup Old Artifacts and Images

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      days_to_keep:
        description: 'Number of days to keep artifacts'
        required: false
        default: '30'
        type: string

permissions:
  actions: write
  packages: write
  contents: read

jobs:
  cleanup-artifacts:
    name: Cleanup Old Workflow Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete old workflow runs and artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const daysToKeep = parseInt('${{ github.event.inputs.days_to_keep || 30 }}');
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);

            console.log(`Deleting artifacts older than ${daysToKeep} days (before ${cutoffDate.toISOString()})`);

            // Get all workflow runs
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let deletedCount = 0;

            for (const run of runs.data.workflow_runs) {
              const runDate = new Date(run.created_at);

              // Skip if run is newer than cutoff
              if (runDate >= cutoffDate) continue;

              // Skip if run is from main/develop branch and is successful
              if ((run.head_branch === 'main' || run.head_branch === 'develop') &&
                  run.conclusion === 'success') {
                console.log(`Keeping artifacts from successful ${run.head_branch} run: ${run.id}`);
                continue;
              }

              try {
                // Get artifacts for this run
                const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });

                // Delete each artifact
                for (const artifact of artifacts.data.artifacts) {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                  console.log(`Deleted artifact: ${artifact.name} from run ${run.id}`);
                }
              } catch (error) {
                console.log(`Error processing run ${run.id}: ${error.message}`);
              }
            }

            console.log(`Total artifacts deleted: ${deletedCount}`);
            core.summary.addHeading('Artifact Cleanup Summary')
              .addRaw(`Deleted ${deletedCount} old artifacts (older than ${daysToKeep} days)`)
              .write();

  cleanup-docker-images:
    name: Cleanup Old Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete old untagged images
        uses: actions/github-script@v7
        with:
          script: |
            const daysToKeep = parseInt('${{ github.event.inputs.days_to_keep || 30 }}');
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);

            console.log(`Deleting untagged images older than ${daysToKeep} days`);

            try {
              // Get package (Docker image)
              const packageName = context.repo.repo;
              const packageType = 'container';

              // List all versions (images)
              const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                package_type: packageType,
                package_name: packageName,
                org: context.repo.owner,
                per_page: 100,
                state: 'active'
              }).catch(async () => {
                // Try user-owned packages if org fails
                return await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                  package_type: packageType,
                  package_name: packageName,
                  username: context.repo.owner,
                  per_page: 100,
                  state: 'active'
                });
              });

              let deletedCount = 0;

              for (const version of versions.data) {
                const versionDate = new Date(version.created_at);

                // Skip if version is newer than cutoff
                if (versionDate >= cutoffDate) continue;

                // Skip if version has tags (keep tagged images)
                if (version.metadata?.container?.tags?.length > 0) {
                  console.log(`Keeping tagged image: ${version.metadata.container.tags.join(', ')}`);
                  continue;
                }

                // Delete untagged old image
                try {
                  await github.rest.packages.deletePackageVersionForOrg({
                    package_type: packageType,
                    package_name: packageName,
                    org: context.repo.owner,
                    package_version_id: version.id
                  }).catch(async () => {
                    // Try user-owned packages if org fails
                    return await github.rest.packages.deletePackageVersionForUser({
                      package_type: packageType,
                      package_name: packageName,
                      username: context.repo.owner,
                      package_version_id: version.id
                    });
                  });

                  deletedCount++;
                  console.log(`Deleted untagged image version: ${version.id}`);
                } catch (error) {
                  console.log(`Error deleting version ${version.id}: ${error.message}`);
                }
              }

              console.log(`Total images deleted: ${deletedCount}`);
              core.summary.addHeading('Docker Image Cleanup Summary')
                .addRaw(`Deleted ${deletedCount} untagged images (older than ${daysToKeep} days)`)
                .write();
            } catch (error) {
              console.log(`Error cleaning up images: ${error.message}`);
              console.log('This may be expected if no container packages exist yet');
            }

  cleanup-cache:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete old caches
        uses: actions/github-script@v7
        with:
          script: |
            const daysToKeep = parseInt('${{ github.event.inputs.days_to_keep || 30 }}');
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);

            console.log(`Deleting caches not accessed in ${daysToKeep} days`);

            try {
              const caches = await github.rest.actions.getActionsCacheList({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });

              let deletedCount = 0;

              for (const cache of caches.data.actions_caches) {
                const lastAccessDate = new Date(cache.last_accessed_at);

                // Skip if cache was accessed recently
                if (lastAccessDate >= cutoffDate) continue;

                // Delete old cache
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id
                  });

                  deletedCount++;
                  console.log(`Deleted cache: ${cache.key} (last accessed: ${cache.last_accessed_at})`);
                } catch (error) {
                  console.log(`Error deleting cache ${cache.id}: ${error.message}`);
                }
              }

              console.log(`Total caches deleted: ${deletedCount}`);
              core.summary.addHeading('Cache Cleanup Summary')
                .addRaw(`Deleted ${deletedCount} caches (not accessed in ${daysToKeep} days)`)
                .write();
            } catch (error) {
              console.log(`Error cleaning up caches: ${error.message}`);
            }

  summary:
    name: Cleanup Summary
    needs: [cleanup-artifacts, cleanup-docker-images, cleanup-cache]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Cleanup Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: ${{ needs.cleanup-artifacts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Images: ${{ needs.cleanup-docker-images.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Caches: ${{ needs.cleanup-cache.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job summaries for details on items deleted." >> $GITHUB_STEP_SUMMARY
