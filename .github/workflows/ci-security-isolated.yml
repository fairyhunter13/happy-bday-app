name: Security Scanning (Isolated)

# ISOLATED WORKFLOW FOR DEBUGGING
# This workflow is used to test and fix security scanning in isolation before reintegrating into main CI
# Trigger manually or on specific branches with 'security-fix' prefix

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'npm-audit'
          - 'owasp'
          - 'trivy'
          - 'license'
          - 'codeql'
      debug_mode:
        description: 'Enable debug mode with verbose logging'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - 'security-fix/**'
      - 'fix/security-*'

concurrency:
  group: security-isolated-${{ github.ref }}
  cancel-in-progress: true

env:
  DEBUG: ${{ github.event.inputs.debug_mode || 'true' }}

jobs:
  npm-audit-isolated:
    name: NPM Audit (Isolated)
    if: github.event.inputs.scan_type == 'npm-audit' || github.event.inputs.scan_type == 'all' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (production)
        id: audit-prod
        run: npm audit --omit=dev --audit-level=critical
        continue-on-error: true

      - name: Run npm audit (all dependencies)
        id: audit-all
        run: npm audit --audit-level=critical
        continue-on-error: true

      - name: Generate audit report
        if: always()
        run: |
          npm audit --json > npm-audit-report.json || true
          npm audit --audit-level=info > npm-audit-report.txt || true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report-isolated
          path: |
            npm-audit-report.json
            npm-audit-report.txt
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Production deps | ${{ steps.audit-prod.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| All deps | ${{ steps.audit-all.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

  owasp-isolated:
    name: OWASP Dependency Check (Isolated)
    if: github.event.inputs.scan_type == 'owasp' || github.event.inputs.scan_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check suppression file exists
        run: |
          if [ -f "dependency-check-suppressions.xml" ]; then
            echo "✅ Suppression file found"
            head -20 dependency-check-suppressions.xml
          else
            echo "⚠️ No suppression file found, creating empty one"
            echo '<?xml version="1.0" encoding="UTF-8"?><suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd"></suppressions>' > dependency-check-suppressions.xml
          fi

      - name: Run OWASP Dependency Check
        id: owasp
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'birthday-message-scheduler'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --suppression /github/workspace/dependency-check-suppressions.xml
        continue-on-error: true

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-report-isolated
          path: reports/
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## OWASP Dependency Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ steps.owasp.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/dependency-check-report.html ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Report generated successfully. Download from artifacts." >> $GITHUB_STEP_SUMMARY
          fi

  trivy-isolated:
    name: Trivy Container Scan (Isolated)
    if: github.event.inputs.scan_type == 'trivy' || github.event.inputs.scan_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        id: docker-build
        run: |
          if [ -f Dockerfile ]; then
            docker build -t test-image:${{ github.sha }} .
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "No Dockerfile found, skipping container scan"
            echo "built=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        if: steps.docker-build.outputs.built == 'true'
        id: trivy-container
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: test-image:${{ github.sha }}
          format: 'table'
          output: 'trivy-container-results.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      - name: Run Trivy filesystem scan
        id: trivy-fs
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-fs-results.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-isolated
          path: |
            trivy-container-results.txt
            trivy-fs-results.txt
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## Trivy Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Container | ${{ steps.trivy-container.outcome == 'success' && '✅' || (steps.docker-build.outputs.built == 'false' && '⏭️ Skipped' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Filesystem | ${{ steps.trivy-fs.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

  license-isolated:
    name: License Compliance (Isolated)
    if: github.event.inputs.scan_type == 'license' || github.event.inputs.scan_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        id: license-check
        run: |
          license-checker --production --json > licenses.json
          license-checker --production --summary > licenses-summary.txt
          cat licenses-summary.txt

      - name: Validate licenses
        id: license-validate
        run: |
          # More precise restricted license patterns
          # Matches: GPL-2.0, GPL-3.0, AGPL-3.0, LGPL-2.1, etc.
          # Does NOT match: LGPL-2.1-only (which is sometimes acceptable)
          RESTRICTED_PATTERNS="(^GPL|^AGPL|^SSPL|Commons Clause)"

          echo "Checking for restricted licenses..."

          # Extract license names and check against patterns
          FOUND_RESTRICTED=$(license-checker --production --json | jq -r '.[] | .licenses' | grep -iE "$RESTRICTED_PATTERNS" || true)

          if [ -n "$FOUND_RESTRICTED" ]; then
            echo "::warning::Found potentially restricted licenses:"
            echo "$FOUND_RESTRICTED"

            # Show full details
            echo ""
            echo "Packages with restricted licenses:"
            license-checker --production --json | jq -r 'to_entries[] | select(.value.licenses | test("'"$RESTRICTED_PATTERNS"'"; "i")) | "\(.key): \(.value.licenses)"' || true

            # Fail for truly restricted licenses (not LGPL)
            TRULY_RESTRICTED=$(echo "$FOUND_RESTRICTED" | grep -iE "^(GPL|AGPL|SSPL)" || true)
            if [ -n "$TRULY_RESTRICTED" ]; then
              echo "::error::Found GPL/AGPL/SSPL licenses which are not compatible"
              exit 1
            fi

            echo "Note: LGPL licenses were found but may be acceptable for dynamic linking"
          else
            echo "✅ All licenses are compliant"
          fi
        continue-on-error: true

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report-isolated
          path: |
            licenses.json
            licenses-summary.txt
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## License Compliance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ steps.license-validate.outcome == 'success' && '✅ Compliant' || '⚠️ Review Required' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### License Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat licenses-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  codeql-isolated:
    name: CodeQL Analysis (Isolated)
    if: github.event.inputs.scan_type == 'codeql' || github.event.inputs.scan_type == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        id: codeql
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript"

      - name: Summary
        if: always()
        run: |
          echo "## CodeQL Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ steps.codeql.outcome == 'success' && '✅ Completed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    needs: [npm-audit-isolated, owasp-isolated, trivy-isolated, license-isolated, codeql-isolated]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.npm-audit-isolated.result }}"
          [ "$RESULT" = "success" ] && EMOJI="✅" || [ "$RESULT" = "skipped" ] && EMOJI="⏭️" || EMOJI="❌"
          echo "| NPM Audit | $EMOJI $RESULT |" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.owasp-isolated.result }}"
          [ "$RESULT" = "success" ] && EMOJI="✅" || [ "$RESULT" = "skipped" ] && EMOJI="⏭️" || EMOJI="❌"
          echo "| OWASP | $EMOJI $RESULT |" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.trivy-isolated.result }}"
          [ "$RESULT" = "success" ] && EMOJI="✅" || [ "$RESULT" = "skipped" ] && EMOJI="⏭️" || EMOJI="❌"
          echo "| Trivy | $EMOJI $RESULT |" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.license-isolated.result }}"
          [ "$RESULT" = "success" ] && EMOJI="✅" || [ "$RESULT" = "skipped" ] && EMOJI="⏭️" || EMOJI="❌"
          echo "| License | $EMOJI $RESULT |" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.codeql-isolated.result }}"
          [ "$RESULT" = "success" ] && EMOJI="✅" || [ "$RESULT" = "skipped" ] && EMOJI="⏭️" || EMOJI="❌"
          echo "| CodeQL | $EMOJI $RESULT |" >> $GITHUB_STEP_SUMMARY

          # Check if any critical scans failed
          if [ "${{ needs.npm-audit-isolated.result }}" = "failure" ] || \
             [ "${{ needs.license-isolated.result }}" = "failure" ]; then
            echo ""
            echo "::error::Critical security scans failed"
            exit 1
          fi

          echo ""
          echo "✅ Security scans completed. Check individual job logs for details."
