name: Mutation Tests

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'stryker.conf.mjs'
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'stryker.conf.mjs'
  workflow_dispatch:

concurrency:
  group: mutation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-app

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Decrypt test secrets
        run: sops --decrypt .env.test.enc > .env.test

      - name: Create reports directory
        run: mkdir -p reports/mutation

      - name: Run mutation testing
        id: mutation
        run: |
          npm run test:mutation:incremental 2>&1 | tee mutation-output.txt
          exit_code=${PIPESTATUS[0]}

          # Extract mutation score from output
          mutation_score=$(grep -oP 'Mutation score.*?(\d+\.?\d*)%' mutation-output.txt | grep -oP '\d+\.?\d*' | tail -1 || echo "0")
          echo "mutation_score=$mutation_score" >> $GITHUB_OUTPUT

          # Extract killed/survived/timeout counts
          killed=$(grep -oP 'Killed:\s*\d+' mutation-output.txt | grep -oP '\d+' || echo "0")
          survived=$(grep -oP 'Survived:\s*\d+' mutation-output.txt | grep -oP '\d+' || echo "0")
          timeout=$(grep -oP 'Timeout:\s*\d+' mutation-output.txt | grep -oP '\d+' || echo "0")
          no_coverage=$(grep -oP 'No Coverage:\s*\d+' mutation-output.txt | grep -oP '\d+' || echo "0")

          echo "killed=$killed" >> $GITHUB_OUTPUT
          echo "survived=$survived" >> $GITHUB_OUTPUT
          echo "timeout=$timeout" >> $GITHUB_OUTPUT
          echo "no_coverage=$no_coverage" >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Cleanup decrypted secrets
        if: always()
        run: rm -f .env.test

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: |
            reports/mutation/
            mutation-output.txt
          retention-days: 14
        if: always()

      - name: Comment mutation score on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const mutationScore = '${{ steps.mutation.outputs.mutation_score }}' || '0';
            const killed = '${{ steps.mutation.outputs.killed }}' || '0';
            const survived = '${{ steps.mutation.outputs.survived }}' || '0';
            const timeout = '${{ steps.mutation.outputs.timeout }}' || '0';
            const noCoverage = '${{ steps.mutation.outputs.no_coverage }}' || '0';

            let statusEmoji = '';
            const score = parseFloat(mutationScore);
            if (score >= 80) statusEmoji = ':white_check_mark:';
            else if (score >= 60) statusEmoji = ':warning:';
            else statusEmoji = ':x:';

            const body = `## ${statusEmoji} Mutation Testing Results

            | Metric | Value |
            |--------|-------|
            | **Mutation Score** | ${mutationScore}% |
            | Killed | ${killed} |
            | Survived | ${survived} |
            | Timeout | ${timeout} |
            | No Coverage | ${noCoverage} |

            ### Thresholds
            - :white_check_mark: High: >= 80%
            - :warning: Low: >= 60%
            - :x: Break: < 50%

            <details>
            <summary>What is mutation testing?</summary>

            Mutation testing introduces small changes (mutations) to your code and checks if your tests catch them. A higher score means better test quality.

            - **Killed**: Tests detected the mutation
            - **Survived**: Mutation went undetected (potential test gap)
            - **Timeout**: Test took too long (usually indicates infinite loop detection)
            - **No Coverage**: Code not covered by tests
            </details>

            [View full report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Mutation Testing Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check mutation score threshold
        run: |
          score="${{ steps.mutation.outputs.mutation_score }}"
          if [ -z "$score" ]; then
            echo "Warning: Could not determine mutation score"
            exit 0
          fi

          echo "Mutation score: $score%"
          if (( $(echo "$score >= 80" | bc -l) )); then
            echo "✓ Excellent! Mutation score meets the high threshold (>=80%)."
          elif (( $(echo "$score >= 60" | bc -l) )); then
            echo "✓ Good. Mutation score is acceptable but could be improved (>=60%)."
          elif (( $(echo "$score >= 50" | bc -l) )); then
            echo "⚠ Warning: Mutation score ($score%) is between low (60%) and break (50%) thresholds."
          else
            echo "✗ Error: Mutation score ($score%) is below the break threshold (50%)"
            exit 1
          fi
