name: Mutation Tests

# Triggered after Unit Tests workflow passes with sufficient coverage

on:
  workflow_run:
    workflows: ["Unit Tests"]
    types: [completed]
    branches: [main, develop]
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'stryker.conf.mjs'
  workflow_dispatch:

concurrency:
  group: mutation-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: 'true'

jobs:
  check-trigger:
    name: Check Trigger Conditions
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if should run
        id: check
        run: |
          # Always run on workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For workflow_run, only run if the triggering workflow succeeded
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "Skipping: Unit Tests workflow did not succeed"
            fi
            exit 0
          fi

          # For pull_request, always run
          echo "should_run=true" >> $GITHUB_OUTPUT

  mutation-testing:
    name: Mutation Testing
    needs: [check-trigger]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-app

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Decrypt test secrets
        run: sops --decrypt .env.test.enc > .env.test

      - name: Create reports directory
        run: mkdir -p reports/mutation

      - name: Run mutation testing
        id: mutation
        run: |
          npm run test:mutation:incremental 2>&1 | tee mutation-output.txt
          exit_code=${PIPESTATUS[0]}

          # Extract mutation score from "Final mutation score XX" or progress line
          # Stryker outputs: "Final mutation score 37.81 under breaking threshold"
          mutation_score=$(grep -oP 'Final mutation score \K[\d.]+' mutation-output.txt | tail -1 || echo "")
          if [ -z "$mutation_score" ]; then
            # Fallback: try to extract from progress line like "Mutation testing 97%"
            mutation_score=$(grep -oP 'Mutation testing \K\d+' mutation-output.txt | tail -1 || echo "0")
          fi
          echo "mutation_score=$mutation_score" >> $GITHUB_OUTPUT

          # Extract counts from the LAST progress line: "(387 survived, 5 timed out)"
          # Format: "tested (X survived, Y timed out)"
          last_progress=$(grep -oP '\d+ survived, \d+ timed out' mutation-output.txt | tail -1 || echo "0 survived, 0 timed out")
          survived=$(echo "$last_progress" | grep -oP '^\d+' || echo "0")
          timeout_count=$(echo "$last_progress" | grep -oP '\d+(?= timed out)' || echo "0")

          # Total tested from last progress line: "2092 tested"
          total_tested=$(grep -oP '\d+/\d+ tested' mutation-output.txt | tail -1 | grep -oP '^\d+' || echo "0")

          # Calculate killed = total_tested - survived - timeout
          killed=$((total_tested - survived - timeout_count))
          if [ "$killed" -lt 0 ]; then killed=0; fi

          # No coverage is harder to extract, set to 0 for now
          no_coverage="0"

          echo "killed=$killed" >> $GITHUB_OUTPUT
          echo "survived=$survived" >> $GITHUB_OUTPUT
          echo "timeout=$timeout_count" >> $GITHUB_OUTPUT
          echo "no_coverage=$no_coverage" >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Cleanup decrypted secrets
        if: always()
        run: rm -f .env.test

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: |
            reports/mutation/
            mutation-output.txt
          retention-days: 14
        if: always()

      - name: Comment mutation score on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const mutationScore = '${{ steps.mutation.outputs.mutation_score }}' || '0';
            const killed = '${{ steps.mutation.outputs.killed }}' || '0';
            const survived = '${{ steps.mutation.outputs.survived }}' || '0';
            const timeout = '${{ steps.mutation.outputs.timeout }}' || '0';
            const noCoverage = '${{ steps.mutation.outputs.no_coverage }}' || '0';

            let statusEmoji = '';
            const score = parseFloat(mutationScore);
            if (score >= 80) statusEmoji = ':white_check_mark:';
            else if (score >= 60) statusEmoji = ':warning:';
            else statusEmoji = ':x:';

            const body = `## ${statusEmoji} Mutation Testing Results

            | Metric | Value |
            |--------|-------|
            | **Mutation Score** | ${mutationScore}% |
            | Killed | ${killed} |
            | Survived | ${survived} |
            | Timeout | ${timeout} |
            | No Coverage | ${noCoverage} |

            ### Thresholds
            - :white_check_mark: High: >= 80%
            - :warning: Low: >= 60%
            - :x: Break: < 50%

            <details>
            <summary>What is mutation testing?</summary>

            Mutation testing introduces small changes (mutations) to your code and checks if your tests catch them. A higher score means better test quality.

            - **Killed**: Tests detected the mutation
            - **Survived**: Mutation went undetected (potential test gap)
            - **Timeout**: Test took too long (usually indicates infinite loop detection)
            - **No Coverage**: Code not covered by tests
            </details>

            [View full report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Mutation Testing Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check mutation score threshold
        run: |
          score="${{ steps.mutation.outputs.mutation_score }}"
          if [ -z "$score" ]; then
            echo "Warning: Could not determine mutation score"
            exit 0
          fi

          echo "Mutation score: $score%"
          if (( $(echo "$score >= 80" | bc -l) )); then
            echo "Excellent! Mutation score meets the high threshold (>=80%)."
          elif (( $(echo "$score >= 60" | bc -l) )); then
            echo "Good. Mutation score is acceptable but could be improved (>=60%)."
          elif (( $(echo "$score >= 50" | bc -l) )); then
            echo "Warning: Mutation score ($score%) is between low (60%) and break (50%) thresholds."
          else
            echo "Error: Mutation score ($score%) is below the break threshold (50%)"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          score="${{ steps.mutation.outputs.mutation_score }}"
          if [ -n "$score" ]; then
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Mutation Score** | ${score}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Killed | ${{ steps.mutation.outputs.killed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Survived | ${{ steps.mutation.outputs.survived }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Timeout | ${{ steps.mutation.outputs.timeout }} |" >> $GITHUB_STEP_SUMMARY
            echo "| No Coverage | ${{ steps.mutation.outputs.no_coverage }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Could not extract mutation score from output" >> $GITHUB_STEP_SUMMARY
          fi
