name: Performance Tests

# Required GitHub Secrets:
# - SOPS_AGE_KEY (required): Decrypt encrypted performance test environment files
# Verification: ./scripts/verify-github-secrets.sh

on:
  schedule:
    - cron: '0 2 * * *' # Daily 2am UTC
  workflow_dispatch: # Allow manual trigger
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - sustained
          - peak
          - worker-scaling

jobs:
  performance-sustained:
    name: Sustained Load Test (1M/day)
    runs-on: ubuntu-latest
    timeout-minutes: 1500 # 25 hours (24h test + 1h buffer)
    if: github.event.inputs.test_type == 'sustained' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-app

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Decrypt test secrets
        run: sops --decrypt .env.test.enc > .env.test

      - name: Start infrastructure services
        run: |
          # Start only infrastructure services (postgres, rabbitmq, redis, prometheus, grafana)
          docker compose -f docker-compose.perf.yml up -d postgres-primary postgres-replica rabbitmq redis prometheus grafana k6

      - name: Wait for database
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c 'until docker exec perf-postgres-primary pg_isready -U perf; do sleep 2; done'
          echo "PostgreSQL is ready"

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db

      - name: Seed performance test users
        run: npm run db:seed:perf
        env:
          NODE_ENV: production
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: perf
          DATABASE_PASSWORD: perf
          DATABASE_NAME: perf_db
          DATABASE_POOL_MIN: 5
          DATABASE_POOL_MAX: 20
          DATABASE_SSL: false
          RABBITMQ_URL: amqp://perf:perf@localhost:5672
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: perf
          RABBITMQ_PASSWORD: perf
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Build API and worker Docker images
        run: docker compose -f docker-compose.perf.yml build --no-cache

      - name: Start API and worker services
        run: |
          # Start API and worker services
          docker compose -f docker-compose.perf.yml up -d api-1 api-2 api-3 api-4 api-5 worker-1 worker-2 worker-3 worker-4 worker-5 worker-6 worker-7 worker-8 worker-9 worker-10 nginx

      - name: Verify containers are running
        run: |
          echo "Waiting for containers to initialize..."
          sleep 10

          echo "Checking container status..."
          docker ps --filter "name=perf-api" --format "table {{.Names}}\t{{.Status}}"
          docker ps --filter "name=perf-nginx" --format "table {{.Names}}\t{{.Status}}"

          # Check if any containers are unhealthy or restarting
          if docker ps --filter "name=perf-api" --filter "status=restarting" | grep -q perf-api; then
            echo "ERROR: API containers are restarting. Checking logs..."
            docker logs perf-api-1 2>&1 | tail -50 || true
            docker logs perf-api-2 2>&1 | tail -50 || true
            docker logs perf-api-3 2>&1 | tail -50 || true
            exit 1
          fi

      - name: Wait for API services
        run: |
          echo "Waiting for API services to be ready..."
          timeout 180 bash -c 'until curl -v -f http://localhost/health; do echo "Health check failed, retrying in 5s..."; sleep 5; done'
          echo "All services are ready"

      - name: Install k6
        uses: ./.github/actions/install-k6

      - name: Create results directory
        run: |
          rm -rf perf-results || true
          mkdir -p perf-results
          chmod 777 perf-results

      - name: Run sustained load test (24h)
        run: k6 run tests/performance/sustained-load.js --out json=perf-results/sustained-load.json
        env:
          API_URL: http://localhost
          CI: true

      - name: Generate performance report
        run: npm run perf:report

      - name: Download baseline results
        if: always()
        uses: dawidd6/action-download-artifact@v3
        with:
          name: performance-baseline
          path: baseline/
          workflow: performance.yml
          workflow_conclusion: success

      - name: Compare with baseline
        id: compare
        run: |
          if [ -f baseline/baseline.json ]; then
            node -e "
              const current = require('./perf-results/sustained-load.json');
              const baseline = require('./baseline/baseline.json');
              const degradation = ((current.p95 - baseline.p95) / baseline.p95) * 100;
              console.log('Degradation: ' + degradation.toFixed(2) + '%');
              if (degradation > 20) {
                console.log('::error::Performance degraded by ' + degradation.toFixed(2) + '% (threshold: 20%)');
                process.exit(1);
              }
            "
          else
            echo "No baseline found, skipping comparison"
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: sustained-load-results
          path: perf-results/
          retention-days: 30

      - name: Update baseline
        if: github.ref == 'refs/heads/main' && success()
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: perf-results/sustained-load.json
          retention-days: 90

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== RabbitMQ Logs ==="
          docker logs perf-rabbitmq 2>&1 | tail -200 || true
          echo "=== API Container Logs ==="
          docker logs perf-api-1 2>&1 | tail -100 || true
          docker logs perf-api-2 2>&1 | tail -100 || true
          docker logs perf-api-3 2>&1 | tail -100 || true
          docker logs perf-api-4 2>&1 | tail -100 || true
          docker logs perf-api-5 2>&1 | tail -100 || true
          echo "=== Worker Logs (sample) ==="
          docker logs perf-worker-1 2>&1 | tail -50 || true
          docker logs perf-worker-2 2>&1 | tail -50 || true
          echo "=== Nginx Logs ==="
          docker logs perf-nginx 2>&1 | tail -100 || true
          echo "=== Docker Container Status ==="
          docker ps -a

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.perf.yml down -v

      - name: Cleanup decrypted secrets
        if: always()
        run: rm -f .env.test

  performance-peak:
    name: Peak Load Test (100+ msg/sec)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.test_type == 'peak' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-app

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Decrypt test secrets
        run: sops --decrypt .env.test.enc > .env.test

      - name: Start infrastructure services
        run: |
          # Start only infrastructure services (excluding k6 - runs on host)
          docker compose -f docker-compose.perf.yml up -d postgres-primary postgres-replica rabbitmq redis prometheus grafana

      - name: Wait for database
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c 'until docker exec perf-postgres-primary pg_isready -U perf; do sleep 2; done'
          echo "PostgreSQL is ready"

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db

      - name: Seed performance test users
        run: npm run db:seed:perf
        env:
          NODE_ENV: production
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: perf
          DATABASE_PASSWORD: perf
          DATABASE_NAME: perf_db
          DATABASE_POOL_MIN: 5
          DATABASE_POOL_MAX: 20
          DATABASE_SSL: false
          RABBITMQ_URL: amqp://perf:perf@localhost:5672
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: perf
          RABBITMQ_PASSWORD: perf
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Build API and worker Docker images
        run: docker compose -f docker-compose.perf.yml build --no-cache

      - name: Start API and worker services
        run: |
          # Start API and worker services
          docker compose -f docker-compose.perf.yml up -d api-1 api-2 api-3 api-4 api-5 worker-1 worker-2 worker-3 worker-4 worker-5 worker-6 worker-7 worker-8 worker-9 worker-10 nginx

      - name: Verify containers are running
        run: |
          echo "Waiting for containers to initialize..."
          sleep 10

          echo "Checking container status..."
          docker ps --filter "name=perf-api" --format "table {{.Names}}\t{{.Status}}"
          docker ps --filter "name=perf-nginx" --format "table {{.Names}}\t{{.Status}}"

          # Check if any containers are unhealthy or restarting
          if docker ps --filter "name=perf-api" --filter "status=restarting" | grep -q perf-api; then
            echo "ERROR: API containers are restarting. Checking logs..."
            docker logs perf-api-1 2>&1 | tail -50 || true
            docker logs perf-api-2 2>&1 | tail -50 || true
            docker logs perf-api-3 2>&1 | tail -50 || true
            exit 1
          fi

      - name: Wait for API services
        run: |
          echo "Waiting for API services to be ready..."
          timeout 180 bash -c 'until curl -v -f http://localhost/health; do echo "Health check failed, retrying in 5s..."; sleep 5; done'
          echo "All services are ready"

      - name: Install k6
        uses: ./.github/actions/install-k6

      - name: Create results directory
        run: |
          rm -rf perf-results || true
          mkdir -p perf-results
          chmod 777 perf-results

      - name: Run peak load test
        run: k6 run tests/performance/peak-load.js --out json=perf-results/peak-load.json
        env:
          API_URL: http://localhost
          CI: true

      - name: Generate performance report
        run: npm run perf:report

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: peak-load-results
          path: perf-results/
          retention-days: 30

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== RabbitMQ Logs ==="
          docker logs perf-rabbitmq 2>&1 | tail -200 || true
          echo "=== API Container Logs ==="
          docker logs perf-api-1 2>&1 | tail -100 || true
          docker logs perf-api-2 2>&1 | tail -100 || true
          docker logs perf-api-3 2>&1 | tail -100 || true
          docker logs perf-api-4 2>&1 | tail -100 || true
          docker logs perf-api-5 2>&1 | tail -100 || true
          echo "=== Worker Logs (sample) ==="
          docker logs perf-worker-1 2>&1 | tail -50 || true
          docker logs perf-worker-2 2>&1 | tail -50 || true
          echo "=== Nginx Logs ==="
          docker logs perf-nginx 2>&1 | tail -100 || true
          echo "=== Docker Container Status ==="
          docker ps -a

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.perf.yml down -v

      - name: Cleanup decrypted secrets
        if: always()
        run: rm -f .env.test

  performance-worker-scaling:
    name: Worker Scaling Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event.inputs.test_type == 'worker-scaling' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'

    strategy:
      matrix:
        workers: [1, 5, 10]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-app

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}

      - name: Decrypt test secrets
        run: sops --decrypt .env.test.enc > .env.test

      - name: Start infrastructure services
        run: |
          # Start only infrastructure services (excluding k6 - runs on host)
          docker compose -f docker-compose.perf.yml up -d postgres-primary postgres-replica rabbitmq redis prometheus grafana

      - name: Wait for database
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c 'until docker exec perf-postgres-primary pg_isready -U perf; do sleep 2; done'
          echo "PostgreSQL is ready"

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db

      - name: Seed performance test users
        run: npm run db:seed:perf
        env:
          NODE_ENV: production
          DATABASE_URL: postgres://perf:perf@localhost:5432/perf_db
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: perf
          DATABASE_PASSWORD: perf
          DATABASE_NAME: perf_db
          DATABASE_POOL_MIN: 5
          DATABASE_POOL_MAX: 20
          DATABASE_SSL: false
          RABBITMQ_URL: amqp://perf:perf@localhost:5672
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: perf
          RABBITMQ_PASSWORD: perf
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Build API and worker Docker images
        run: docker compose -f docker-compose.perf.yml build --no-cache

      - name: Start API and worker services (${{ matrix.workers }} workers)
        run: |
          # Start API services and specific number of workers
          docker compose -f docker-compose.perf.yml up -d api-1 api-2 api-3 api-4 api-5 nginx
          if [ "${{ matrix.workers }}" = "1" ]; then
            docker compose -f docker-compose.perf.yml up -d worker-1
          elif [ "${{ matrix.workers }}" = "5" ]; then
            docker compose -f docker-compose.perf.yml up -d worker-1 worker-2 worker-3 worker-4 worker-5
          elif [ "${{ matrix.workers }}" = "10" ]; then
            docker compose -f docker-compose.perf.yml up -d worker-1 worker-2 worker-3 worker-4 worker-5 worker-6 worker-7 worker-8 worker-9 worker-10
          fi

      - name: Verify containers are running
        run: |
          echo "Waiting for containers to initialize..."
          sleep 10

          echo "Checking container status..."
          docker ps --filter "name=perf-api" --format "table {{.Names}}\t{{.Status}}"
          docker ps --filter "name=perf-nginx" --format "table {{.Names}}\t{{.Status}}"

          # Check if any containers are unhealthy or restarting
          if docker ps --filter "name=perf-api" --filter "status=restarting" | grep -q perf-api; then
            echo "ERROR: API containers are restarting. Checking logs..."
            docker logs perf-api-1 2>&1 | tail -50 || true
            docker logs perf-api-2 2>&1 | tail -50 || true
            docker logs perf-api-3 2>&1 | tail -50 || true
            exit 1
          fi

      - name: Wait for API services
        run: |
          echo "Waiting for API services to be ready..."
          timeout 180 bash -c 'until curl -v -f http://localhost/health; do echo "Health check failed, retrying in 5s..."; sleep 5; done'
          echo "All services are ready"

      - name: Install k6
        uses: ./.github/actions/install-k6

      - name: Create results directory
        run: |
          rm -rf perf-results || true
          mkdir -p perf-results
          chmod 777 perf-results

      - name: Run worker scaling test
        run: k6 run tests/performance/worker-scaling.js --out json=perf-results/worker-scaling-${{ matrix.workers }}.json
        env:
          API_URL: http://localhost
          WORKERS: ${{ matrix.workers }}
          CI: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: worker-scaling-results-${{ matrix.workers }}
          path: perf-results/
          retention-days: 30

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== RabbitMQ Logs ==="
          docker logs perf-rabbitmq 2>&1 | tail -200 || true
          echo "=== API Container Logs ==="
          docker logs perf-api-1 2>&1 | tail -100 || true
          docker logs perf-api-2 2>&1 | tail -100 || true
          docker logs perf-api-3 2>&1 | tail -100 || true
          docker logs perf-api-4 2>&1 | tail -100 || true
          docker logs perf-api-5 2>&1 | tail -100 || true
          echo "=== Worker Logs (sample) ==="
          docker logs perf-worker-1 2>&1 | tail -50 || true
          docker logs perf-worker-2 2>&1 | tail -50 || true
          echo "=== Nginx Logs ==="
          docker logs perf-nginx 2>&1 | tail -100 || true
          echo "=== Docker Container Status ==="
          docker ps -a

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.perf.yml down -v

      - name: Cleanup decrypted secrets
        if: always()
        run: rm -f .env.test

  performance-report:
    name: Generate Performance Report
    needs: [performance-sustained, performance-peak, performance-worker-scaling]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all performance artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-results*'
          path: perf-results/

      - name: Generate consolidated report
        run: npm run perf:report

      - name: Generate performance badges
        run: |
          chmod +x scripts/performance/generate-badges.sh
          ./scripts/performance/generate-badges.sh perf-results docs

      - name: Upload performance badges
        uses: actions/upload-artifact@v4
        with:
          name: performance-badges
          path: |
            docs/performance-badge.json
            docs/rps-badge.json
            docs/latency-badge.json
            docs/throughput-badge.json
            docs/error-rate-badge.json
            docs/performance-metrics.json
          retention-days: 90

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-final
          path: perf-results/performance-report.html
          retention-days: 90

      - name: Comment on commit
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('perf-results/summary.json', 'utf8'));

            const comment = `## Performance Test Results

            üìä **Weekly Performance Test Summary**

            | Test | Status | P95 Latency | P99 Latency | Error Rate |
            |------|--------|-------------|-------------|------------|
            | Sustained Load (1M/day) | ${summary.tests[0]?.success ? '‚úÖ' : '‚ùå'} | - | - | - |
            | Peak Load (100+ msg/sec) | ${summary.tests[1]?.success ? '‚úÖ' : '‚ùå'} | - | - | - |
            | Worker Scaling | ${summary.tests[2]?.success ? '‚úÖ' : '‚ùå'} | - | - | - |

            [Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

