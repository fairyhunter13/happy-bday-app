# Grafana Alert Rules for Birthday Message Scheduler
# These rules define when alerts should fire based on metrics

groups:
  - name: critical_alerts
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="birthday-scheduler"} == 0
        for: 1m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "Birthday Scheduler service is down"
          description: "The Birthday Scheduler service has been down for more than 1 minute"
          runbook: "https://docs.example.com/runbooks/service-down"

      - alert: HighErrorRate
        expr: (rate(http_requests_total{job="birthday-scheduler",status=~"5.."}[5m]) / rate(http_requests_total{job="birthday-scheduler"}[5m])) * 100 > 10
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High API error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 10%)"
          runbook: "https://docs.example.com/runbooks/high-error-rate"

      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state{job="birthday-scheduler"} == 1
        for: 2m
        labels:
          severity: critical
          component: external-service
        annotations:
          summary: "Circuit breaker is open for {{ $labels.service }}"
          description: "Circuit breaker has been open for 2 minutes, external service {{ $labels.service }} is failing"
          runbook: "https://docs.example.com/runbooks/circuit-breaker-open"

      - alert: QueueDepthCritical
        expr: rabbitmq_queue_messages{queue="birthday_messages"} > 5000
        for: 5m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Message queue depth is critically high"
          description: "Queue depth is {{ $value }} messages (threshold: 5000)"
          runbook: "https://docs.example.com/runbooks/queue-overflow"

      - alert: MessageDeliverySuccessRateLow
        expr: (sum(rate(birthday_messages_sent_success[5m])) / sum(rate(birthday_messages_sent_total[5m]))) * 100 < 95
        for: 10m
        labels:
          severity: critical
          component: message-delivery
        annotations:
          summary: "Message delivery success rate is below threshold"
          description: "Success rate is {{ $value | humanizePercentage }} (threshold: 95%)"
          runbook: "https://docs.example.com/runbooks/low-success-rate"

      - alert: SchedulerExecutionFailure
        expr: rate(scheduler_execution_failures_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
          component: scheduler
        annotations:
          summary: "Scheduler {{ $labels.scheduler }} is failing"
          description: "Scheduler has {{ $value }} failures per second"
          runbook: "https://docs.example.com/runbooks/scheduler-failure"

      - alert: DatabaseConnectionPoolExhausted
        expr: (pg_stat_database_numbackends{datname="birthday_scheduler"} / pg_settings_max_connections) * 100 > 90
        for: 3m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Connection pool usage is {{ $value | humanizePercentage }} (threshold: 90%)"
          runbook: "https://docs.example.com/runbooks/db-pool-exhaustion"

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Disk space critically low"
          description: "Available disk space is {{ $value | humanizePercentage }} (threshold: 10%)"
          runbook: "https://docs.example.com/runbooks/disk-space-low"

  - name: warning_alerts
    interval: 1m
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="birthday-scheduler"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API response time is high"
          description: "P99 response time is {{ $value }}s (threshold: 1s)"
          runbook: "https://docs.example.com/runbooks/high-response-time"

      - alert: ModerateErrorRate
        expr: (rate(http_requests_total{job="birthday-scheduler",status=~"5.."}[5m]) / rate(http_requests_total{job="birthday-scheduler"}[5m])) * 100 > 5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "Elevated API error rate"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook: "https://docs.example.com/runbooks/elevated-errors"

      - alert: QueueDepthHigh
        expr: rabbitmq_queue_messages{queue="birthday_messages"} > 1000
        for: 10m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Message queue depth is elevated"
          description: "Queue depth is {{ $value }} messages (threshold: 1000)"
          runbook: "https://docs.example.com/runbooks/queue-backing-up"

      - alert: DatabaseConnectionPoolHigh
        expr: (pg_stat_database_numbackends{datname="birthday_scheduler"} / pg_settings_max_connections) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool usage is high"
          description: "Connection pool usage is {{ $value | humanizePercentage }} (threshold: 80%)"
          runbook: "https://docs.example.com/runbooks/db-pool-high"

      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes{job="birthday-scheduler"} / 1024 / 1024 / 1024) > 1.5
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "Application memory usage is high"
          description: "Memory usage is {{ $value | humanize }}GB (threshold: 1.5GB)"
          runbook: "https://docs.example.com/runbooks/high-memory"

      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="birthday-scheduler"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "Application CPU usage is high"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"
          runbook: "https://docs.example.com/runbooks/high-cpu"

      - alert: WorkerCrashRecovery
        expr: increase(worker_restarts_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "Worker {{ $labels.worker }} has restarted"
          description: "Worker has restarted {{ $value }} times in the last 5 minutes"
          runbook: "https://docs.example.com/runbooks/worker-restart"

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Disk space is running low"
          description: "Available disk space is {{ $value | humanizePercentage }} (threshold: 20%)"
          runbook: "https://docs.example.com/runbooks/disk-space-low"

      - alert: RateLimitExceeded
        expr: rate(rate_limit_exceeded_total{job="birthday-scheduler"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "Rate limit being frequently exceeded"
          description: "Rate limit exceeded {{ $value }} times per second"
          runbook: "https://docs.example.com/runbooks/rate-limit-exceeded"

  - name: performance_alerts
    interval: 2m
    rules:
      - alert: SlowDatabaseQueries
        expr: rate(pg_stat_statements_mean_exec_time[5m]) > 100
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database queries are running slow"
          description: "Average query time is {{ $value }}ms (threshold: 100ms)"
          runbook: "https://docs.example.com/runbooks/slow-queries"

      - alert: MessageProcessingBacklog
        expr: rabbitmq_queue_messages_unacknowledged{queue="birthday_messages"} > 100
        for: 15m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "Message processing backlog detected"
          description: "{{ $value }} messages are unacknowledged (threshold: 100)"
          runbook: "https://docs.example.com/runbooks/processing-backlog"

      - alert: LowThroughput
        expr: rate(birthday_messages_sent_total[5m]) < 1
        for: 30m
        labels:
          severity: info
          component: message-delivery
        annotations:
          summary: "Message throughput is low"
          description: "Sending {{ $value }} messages per second (expected: >1 msg/s)"
          runbook: "https://docs.example.com/runbooks/low-throughput"

# Notification routing
# Configure in Grafana UI or via provisioning

alerting:
  contactpoints:
    - name: slack-critical
      type: slack
      settings:
        url: "${SLACK_WEBHOOK_URL}"
        title: "ðŸš¨ CRITICAL: {{ .CommonAnnotations.summary }}"

    - name: pagerduty-critical
      type: pagerduty
      settings:
        integrationKey: "${PAGERDUTY_KEY}"
        severity: critical

    - name: email-team
      type: email
      settings:
        addresses: "team@example.com"

  notification_policies:
    - match:
        severity: critical
      receiver: pagerduty-critical
      continue: true

    - match:
        severity: critical
      receiver: slack-critical
      continue: true

    - match:
        severity: warning
      receiver: slack-critical

    - match:
        severity: info
      receiver: email-team
