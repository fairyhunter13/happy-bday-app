{
  "openapi": "3.0.3",
  "info": {
    "title": "Birthday Message Scheduler API",
    "description": "## Overview\nProduction-ready API for scheduling birthday and anniversary messages with timezone support.\n\n## Features\n- **User Management**: Create, read, update, and delete users with timezone support\n- **Message Scheduling**: Automatic message scheduling based on user timezone (at 9am local time)\n- **Health Monitoring**: System health and readiness endpoints\n- **Metrics**: Prometheus-formatted metrics for monitoring\n- **Caching**: Redis-based caching for improved performance\n\n## Architecture\n- **Database**: PostgreSQL with Drizzle ORM\n- **Queue**: RabbitMQ for message processing\n- **Cache**: Redis for high-performance caching\n- **Scheduler**: CRON-based scheduling with timezone awareness\n\n## Caching Strategy\nThis API uses Redis caching to improve performance and reduce database load:\n\n### Cached Data\n| Data | TTL | Key Pattern |\n|------|-----|-------------|\n| User by ID | 1 hour | `user:v1:{id}` |\n| User by Email | 1 hour | `user:email:v1:{email}` |\n| Birthdays Today | Until midnight | `birthdays:today:v1` |\n| Anniversaries Today | Until midnight | `anniversaries:today:v1` |\n\n### Cache Behavior\n- **GET requests**: Served from cache when available (eventual consistency)\n- **POST requests**: Warm cache after creation\n- **PUT/DELETE requests**: Invalidate cache after modification\n- **Graceful degradation**: API works without Redis (cache is optional)\n\n### Consistency Models\n- **Strong consistency**: Write operations always hit the database\n- **Eventual consistency**: Read operations may return cached data (up to 1 hour stale)\n- **Weak consistency**: Daily lists (birthdays/anniversaries) refresh at midnight UTC\n\n## API Endpoints\nThis API provides the following endpoint groups:\n- `/health`, `/ready`, `/live` - Health check endpoints\n- `/metrics` - Prometheus metrics\n- `/api/v1/users` - User CRUD operations",
    "version": "1.0.0",
    "contact": {
      "name": "API Support",
      "email": "support@birthday-scheduler.example.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "components": {
    "schemas": {
      "User": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique user identifier"
          },
          "firstName": {
            "type": "string",
            "description": "User's first name"
          },
          "lastName": {
            "type": "string",
            "description": "User's last name"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address"
          },
          "timezone": {
            "type": "string",
            "example": "America/New_York",
            "description": "User's timezone (IANA format)"
          },
          "birthdayDate": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "User's birthday date"
          },
          "anniversaryDate": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "User's anniversary date"
          },
          "locationCity": {
            "type": "string",
            "nullable": true,
            "description": "User's city"
          },
          "locationCountry": {
            "type": "string",
            "nullable": true,
            "description": "User's country"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Record creation timestamp"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Record last update timestamp"
          }
        }
      },
      "CreateUserRequest": {
        "type": "object",
        "required": [
          "firstName",
          "lastName",
          "email",
          "timezone"
        ],
        "properties": {
          "firstName": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "User's first name"
          },
          "lastName": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "User's last name"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address (must be unique)"
          },
          "timezone": {
            "type": "string",
            "example": "America/New_York",
            "description": "User's timezone in IANA format (e.g., America/New_York, Europe/London)"
          },
          "birthdayDate": {
            "type": "string",
            "format": "date-time",
            "description": "User's birthday date (for birthday message scheduling)"
          },
          "anniversaryDate": {
            "type": "string",
            "format": "date-time",
            "description": "User's anniversary date (for anniversary message scheduling)"
          },
          "locationCity": {
            "type": "string",
            "maxLength": 100,
            "description": "User's city (optional)"
          },
          "locationCountry": {
            "type": "string",
            "maxLength": 100,
            "description": "User's country (optional)"
          }
        }
      },
      "UpdateUserRequest": {
        "type": "object",
        "properties": {
          "firstName": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "User's first name"
          },
          "lastName": {
            "type": "string",
            "minLength": 1,
            "maxLength": 100,
            "description": "User's last name"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "User's email address"
          },
          "timezone": {
            "type": "string",
            "example": "America/New_York",
            "description": "User's timezone in IANA format"
          },
          "birthdayDate": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "User's birthday date"
          },
          "anniversaryDate": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "User's anniversary date"
          },
          "locationCity": {
            "type": "string",
            "maxLength": 100,
            "nullable": true,
            "description": "User's city"
          },
          "locationCountry": {
            "type": "string",
            "maxLength": 100,
            "nullable": true,
            "description": "User's country"
          }
        },
        "description": "All fields are optional - only provided fields will be updated"
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "healthy",
              "unhealthy"
            ],
            "description": "Overall health status"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Health check timestamp"
          },
          "uptime": {
            "type": "number",
            "description": "Service uptime in seconds"
          },
          "version": {
            "type": "string",
            "description": "Application version"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string",
                "description": "Error code (e.g., VALIDATION_ERROR, NOT_FOUND)"
              },
              "message": {
                "type": "string",
                "description": "Human-readable error message"
              },
              "details": {
                "type": "object",
                "description": "Additional error details"
              }
            }
          }
        }
      },
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "data": {
            "type": "object",
            "description": "Response data (structure varies by endpoint)"
          },
          "meta": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "requestId": {
                "type": "string"
              }
            }
          }
        }
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "operationId": "getHealth",
        "summary": "Health check",
        "tags": [
          "health"
        ],
        "description": "Basic health check endpoint. Returns 200 if the service is running.",
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/ready": {
      "get": {
        "operationId": "getReady",
        "summary": "Readiness check",
        "tags": [
          "health"
        ],
        "description": "Kubernetes readiness probe. Checks if the service is ready to accept requests (database, queue, etc. are connected).",
        "responses": {
          "200": {
            "description": "Service is ready",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          },
          "503": {
            "description": "Service is not ready (dependencies unavailable)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/live": {
      "get": {
        "operationId": "getLive",
        "summary": "Liveness check",
        "tags": [
          "health"
        ],
        "description": "Kubernetes liveness probe. Checks if the service process is alive and should not be restarted.",
        "responses": {
          "200": {
            "description": "Service is alive",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/health/schedulers": {
      "get": {
        "operationId": "getSchedulerHealth",
        "summary": "Scheduler health check",
        "tags": [
          "health"
        ],
        "description": "Check the health status of all CRON schedulers (daily precalculation, minute enqueue, recovery).",
        "responses": {
          "200": {
            "description": "Scheduler health information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/metrics": {
      "get": {
        "operationId": "getMetrics",
        "summary": "Prometheus metrics",
        "tags": [
          "metrics"
        ],
        "description": "Get Prometheus-formatted metrics for monitoring. Includes HTTP request metrics, message processing metrics, and system metrics.",
        "responses": {
          "200": {
            "description": "Prometheus text format metrics",
            "content": {
              "text/plain": {
                "schema": {
                  "type": "string",
                  "description": "Prometheus text format metrics"
                }
              }
            }
          }
        }
      }
    },
    "/metrics/summary": {
      "get": {
        "operationId": "getMetricsSummary",
        "summary": "Metrics summary",
        "tags": [
          "metrics"
        ],
        "description": "Get a JSON summary of all metrics for debugging and dashboard integration.",
        "responses": {
          "200": {
            "description": "Metrics summary in JSON format",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/users": {
      "post": {
        "operationId": "createUser",
        "summary": "Create a new user",
        "tags": [
          "users"
        ],
        "description": "Create a new user with timezone support. The system will automatically schedule birthday and anniversary messages at 9am in the user's local timezone. Cache is warmed after successful creation for faster subsequent reads.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateUserRequest"
              },
              "example": {
                "firstName": "John",
                "lastName": "Doe",
                "email": "john.doe@example.com",
                "timezone": "America/New_York",
                "birthdayDate": "1990-05-15T00:00:00.000Z",
                "locationCity": "New York",
                "locationCountry": "USA"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation error (invalid input data)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "409": {
            "description": "Conflict (email already exists)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/users/{id}": {
      "get": {
        "operationId": "getUserById",
        "summary": "Get user by ID",
        "tags": [
          "users"
        ],
        "description": "Retrieve a specific user by their UUID. Results may be served from cache (up to 1 hour stale).",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "User UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "User found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "User not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "put": {
        "operationId": "updateUser",
        "summary": "Update user",
        "tags": [
          "users"
        ],
        "description": "Update an existing user. If birthday or anniversary date is changed, the system will automatically reschedule the corresponding messages. Cache is invalidated after update to ensure consistency.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "User UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateUserRequest"
              },
              "example": {
                "firstName": "Jane",
                "timezone": "Europe/London"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "User updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "User not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "409": {
            "description": "Conflict (email already in use by another user)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "delete": {
        "operationId": "deleteUser",
        "summary": "Delete user",
        "tags": [
          "users"
        ],
        "description": "Soft delete a user. The user record is marked as deleted but retained in the database. Any pending messages for this user will be cancelled. Cache is invalidated after deletion.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "User UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "User deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          },
          "404": {
            "description": "User not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Local development server"
    }
  ],
  "tags": [
    {
      "name": "health",
      "description": "Health check endpoints for monitoring and Kubernetes orchestration"
    },
    {
      "name": "metrics",
      "description": "Prometheus metrics endpoints for observability"
    },
    {
      "name": "users",
      "description": "User management operations (CRUD)"
    }
  ]
}
